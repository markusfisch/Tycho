<!doctype html>
<html>
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0"/>
<title>(LD29)</title>
<style>

body
{
	background: #000;
	margin: 0; padding: 0;
	overflow: hidden;
}

#Message
{
	position: fixed;
	z-index: 4;
	left: 0; top: 0;
	right: 0; bottom: 0;
	background: #fff;
	padding: 4em 1em 0;
	font: 16pt sans-serif; color: #111;
	font-weight: lighter;
	letter-spacing: .2em;
	line-height: 150%;
	text-align: center;
	text-transform: uppercase;
}

</style>
</head>
<body>
<div id="Message">Initializing</div>
<script>

"use strict";

var requestAnimFrame =
		window.webkitRequestAnimationFrame ||
		window.mozRequestAnimationFrame ||
		window.msRequestAnimationFrame ||
		window.oRequestAnimationFrame ||
		window.requestAnimationFrame ||
		function( callback )
		{
			window.setTimeout( callback, 16 );
		},
	resources = {
		surfaceEmpty:{
			rect: {/*surface-empty*/x:266,y:2,w:128,h:128},
		},
		surfaceStones:{
			blocks: true,
			rect: {/*surface-stones*/x:2,y:2,w:128,h:128},
		},
		surfaceEntry:{
			rect: {/*surface-entry*/x:134,y:2,w:128,h:128},
		},
		surfaceAstronautDownStand:{
			rect: {/*surface-astronaut-down-stand*/x:971,y:134,w:40,h:84},
		},
		surfaceAstronautDownWalk0:{
			rect: {/*surface-astronaut-down-walk0*/x:1058,y:134,w:39,h:80},
		},
		surfaceAstronautDownWalk1:{
			rect: {/*surface-astronaut-down-walk1*/x:1015,y:134,w:39,h:81},
		},
		surfaceAstronautUpStand:{
			rect: {/*surface-astronaut-up-stand*/x:927,y:134,w:40,h:86},
		},
		surfaceAstronautUpWalk0:{
			rect: {/*surface-astronaut-up-walk0*/x:883,y:134,w:40,h:86},
		},
		surfaceAstronautUpWalk1:{
			rect: {/*surface-astronaut-up-walk1*/x:838,y:134,w:41,h:86},
		},
		surfaceAstronautRightWalk0:{
			rect: {/*surface-astronaut-right-walk0*/x:1101,y:134,w:37,h:76},
		},
		surfaceAstronautRightWalk1:{
			rect: {/*surface-astronaut-right-walk1*/x:1142,y:134,w:33,h:74},
		},
		surfaceAstronautLeftWalk0:{
			mirror: true,
			rect: {/*surface-astronaut-right-walk0*/x:1101,y:134,w:37,h:76},
		},
		surfaceAstronautLeftWalk1:{
			mirror: true,
			rect: {/*surface-astronaut-right-walk1*/x:1142,y:134,w:33,h:74},
		},
		beneathAstronautRightStand:{
			rect: {/*beneath-astronaut-right-stand*/x:795,y:134,w:39,h:92},
		},
		beneathAstronautRightWalk0:{
			rect: {/*beneath-astronaut-right-walk0*/x:1982,y:2,w:40,h:94},
		},
		beneathAstronautRightWalk1:{
			rect: {/*beneath-astronaut-right-walk1*/x:662,y:134,w:43,h:92},
		},
		beneathAstronautRightWalk2:{
			rect: {/*beneath-astronaut-right-walk2*/x:752,y:134,w:39,h:92},
		},
		beneathAstronautRightWalk3:{
			rect: {/*beneath-astronaut-right-walk3*/x:709,y:134,w:39,h:92},
		},
		beneathAstronautLeftStand:{
			mirror: true,
			rect: {/*beneath-astronaut-right-stand*/x:795,y:134,w:39,h:92},
		},
		beneathAstronautLeftWalk0:{
			mirror: true,
			rect: {/*beneath-astronaut-right-walk0*/x:1982,y:2,w:40,h:94},
		},
		beneathAstronautLeftWalk1:{
			mirror: true,
			rect: {/*beneath-astronaut-right-walk1*/x:662,y:134,w:43,h:92},
		},
		beneathAstronautLeftWalk2:{
			mirror: true,
			rect: {/*beneath-astronaut-right-walk2*/x:752,y:134,w:39,h:92},
		},
		beneathAstronautLeftWalk3:{
			mirror: true,
			rect: {/*beneath-astronaut-right-walk3*/x:709,y:134,w:39,h:92},
		},
		beneathEntry:{
			rect: {/*beneath-entry*/x:1454,y:2,w:128,h:128},
		},
		beneathCorridor:{
			rect: {/*beneath-corridor*/x:1850,y:2,w:128,h:128},
		},
		beneathCorridorTopLeft:{
			rect: {/*beneath-corridor-top-left*/x:134,y:134,w:128,h:128},
		},
		beneathCorridorTopRight:{
			rect: {/*beneath-corridor-top-right*/x:2,y:134,w:128,h:128},
		},
		beneathCorridorLeftRight:{
			rect: {/*beneath-corridor-left-right*/x:398,y:134,w:128,h:128},
		},
		beneathCorridorLeftEnd:{
			blocks: true,
			rect: {/*beneath-corridor-left-end*/x:530,y:134,w:128,h:128},
		},
		beneathCorridorRightEnd:{
			blocks: true,
			rect: {/*beneath-corridor-right-end*/x:266,y:134,w:128,h:128},
		},
		beneathDropLeft:{
			rect: {/*beneath-drop-left*/x:1718,y:2,w:128,h:128},
		},
		beneathDropRight:{
			rect: {/*beneath-drop-right*/x:1586,y:2,w:128,h:128},
		},
		beneathWallTop:{
			blocks: true,
			rect: {/*beneath-wall-top*/x:398,y:2,w:128,h:128},
		},
		beneathWallBottom:{
			blocks: true,
			rect: {/*beneath-wall-bottom*/x:1322,y:2,w:128,h:128},
		},
		beneathWallLeft:{
			blocks: true,
			rect: {/*beneath-wall-left*/x:926,y:2,w:128,h:128},
		},
		beneathWallLeftTop:{
			blocks: true,
			rect: {/*beneath-wall-left-top*/x:1058,y:2,w:128,h:128},
		},
		beneathWallLeftBottom:{
			blocks: true,
			rect: {/*beneath-wall-left-bottom*/x:1190,y:2,w:128,h:128},
		},
		beneathWallRight:{
			blocks: true,
			rect: {/*beneath-wall-right*/x:530,y:2,w:128,h:128},
		},
		beneathWallRightTop:{
			blocks: true,
			rect: {/*beneath-wall-right-top*/x:662,y:2,w:128,h:128},
		},
		beneathWallRightBottom:{
			blocks: true,
			rect: {/*beneath-wall-right-bottom*/x:794,y:2,w:128,h:128},
		} },
	levels = [
		{
			sideView: false,
			cols: 16,
			rows: 16,
			x: 7,
			y: 7,
			map: [
				0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
				0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
				0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 1, 0, 1, 0,
				0, 1, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0,
				0, 0, 0, 1, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1, 1, 0,
				0, 0, 0, 1, 0, 1, 0, 0, 0, 0, 1, 0, 0, 0, 1, 0,
				0, 0, 1, 0, 0, 0, 0, 2, 0, 0, 0, 0, 0, 0, 0, 1,
				0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1,
				0, 0, 1, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0,
				0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1, 0,
				0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0,
				0, 0, 0, 0, 1, 0, 0, 0, 1, 1, 0, 0, 1, 0, 0, 0,
				0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0,
				0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 0, 0, 0,
				0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
				0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
			symbols: [
				/*0*/"surfaceEmpty",
				/*1*/"surfaceStones",
				/*2*/"surfaceEntry"],
			actions: [
				/*0*/null,
				/*1*/null,
				/*2*/function( col, row )
				{
					loadLevel( {
						sideView: true,
						cols: 6,
						rows: 6,
						x: 1,
						y: 0,
						map: [
							1, 2, 8,10,16, 0,
							0, 0,12, 7,15, 0,
							0, 0,12, 7,15, 0,
							0, 0,14,11,17, 0,
							0, 0, 0, 0, 0, 0,
							0, 0, 0, 0, 0, 0],
						symbols: [
							/*00*/null,
							/*01*/"beneathEntry",
							/*02*/"beneathCorridorLeftRight",
							/*03*/"beneathCorridorLeftEnd",
							/*04*/"beneathCorridorRightEnd",
							/*05*/"beneathCorridorTopLeft",
							/*06*/"beneathCorridorTopRight",
							/*07*/"beneathCorridor",
							/*08*/"beneathDropLeft",
							/*09*/"beneathDropRight",
							/*10*/"beneathWallTop",
							/*11*/"beneathWallBottom",
							/*12*/"beneathWallLeft",
							/*13*/"beneathWallLeftTop",
							/*14*/"beneathWallLeftBottom",
							/*15*/"beneathWallRight",
							/*16*/"beneathWallRightTop",
							/*17*/"beneathWallRightBottom"],
						actions: [
							/*0*/null,
							/*1*/function()
							{
								loadLevel( levels[0], col, row );
							}]
					} );
				}]
		}
		],
	message,
	atlas,
	sprites = {},
	now,
	factor,
	last,
	canvas,
	ctx,
	ratio,
	resizeTimer,
	centerX,
	centerY,
	width,
	height,
	cellSize,
	pointerX,
	pointerY,
	pointerSet = false,
	keysDown = [],
	map = [],
	mapCols,
	mapRows,
	mapCells,
	mapSideView,
	mapWidth,
	mapHeight,
	mapLeft,
	mapTop,
	playerCol,
	playerRow,
	playerVx,
	playerVy,
	playerFallSpeed = 0,
	playerWalk = 0,
	playerWalkLast = 0,
	playerWalkFrequency = 96,
	playerSize,
	playerSizeInMap,
	step = .0625;

function enter()
{
	var idx = (playerRow | 0)*mapCols+(playerCol | 0),
		field = map[idx];

	if( field.action )
		field.action( playerCol, playerRow-1 );
}

function cell( col, row )
{
	var idx = (row | 0)*mapCols+(col | 0);

	if( idx < mapCells )
	{
		var field = map[idx];

		if( !field )
			return false;

		return !field.blocks;
	}

	return false;
}

function canMoveTo( col, row )
{
	var left = col-playerSizeInMap,
		top = row-playerSizeInMap,
		right = col+playerSizeInMap,
		bottom = row+playerSizeInMap;

	return cell( left, top ) &&
		cell( right, top ) &&
		cell( left, bottom ) &&
		cell( right, bottom );
}

function moveToBorder( col, row )
{
	if( col < 0 )
		playerCol = (playerCol | 0)+playerSizeInMap+.01;
	else if( col > 0 )
		playerCol = (playerCol | 0)+(.99-playerSizeInMap);

	if( row < 0 )
		playerRow = (playerRow | 0)+playerSizeInMap+.01;
	else if( row > 0 )
		playerRow = (playerRow | 0)+(.99-playerSizeInMap);
}

function moveTo( col, row )
{
	if( col < playerSizeInMap )
		col = playerSizeInMap;
	else if( col > mapCols-playerSizeInMap )
		col = mapCols-playerSizeInMap;

	if( playerFallSpeed )
		row = playerRow;
	else if( row < playerSizeInMap )
		row = playerSizeInMap;
	else if( row > mapRows-playerSizeInMap )
		row = mapRows-playerSizeInMap;

	var dx = col-playerCol,
		dy = row-playerRow,
		x = playerCol,
		y = playerRow,
		s = step*factor;

	if( Math.abs( dx ) > s )
		dx = dx > 0 ? s : -s;

	if( Math.abs( dy ) > s )
		dy = dy > 0 ? s : -s;

	x += dx;

	if( !mapSideView )
		y += dy;

	if( canMoveTo( x, y ) )
	{
		playerVx = dx;
		playerVy = dy;

		playerCol = x;
		playerRow = y;
	}
	else if( canMoveTo( x, playerRow ) )
	{
		playerVx = dx;
		playerVy = 0;

		playerCol = x;
		moveToBorder( 0, dy );
	}
	else if( canMoveTo( playerCol, y ) )
	{
		playerVx = 0;
		playerVy = dy;

		playerRow = y;
		moveToBorder( dx, 0 );
	}
	else
		moveToBorder( dx, dy );
}

function drawSprite( sprite, x, y )
{
	ctx.drawImage(
		sprite,
		x-sprite.centerX,
		y-sprite.centerY );
}

function drawPlayer( x, y )
{
	var sprite;

	if( (playerVx != 0 || playerVy != 0) &&
		now-playerWalkLast > playerWalkFrequency )
	{
		playerWalk = ++playerWalk % (mapSideView ? 4 : 2);
		playerWalkLast = now;
	}

	if( mapSideView || playerVx != 0 )
	{
		if( playerVx == 0 )
			sprite = mapSideView ?
				"LeftStand" :
				"DownStand";
		else if( playerVx > 0 )
			sprite = "RightWalk"+playerWalk;
		else
			sprite = "LeftWalk"+playerWalk;
	}
	else
	{
		if( playerVy == 0 )
			sprite = "DownStand";
		else if( playerVy > 0 )
			sprite = "DownWalk"+playerWalk;
		else
			sprite = "UpWalk"+playerWalk;
	}

	drawSprite(
		sprites[(mapSideView ?
			"beneathAstronaut" :
			"surfaceAstronaut")+sprite],
		x,
		y );
}

function drawMap( left, top )
{
	var size = cellSize+1,
		startCol = 0,
		skip = 0,
		y = mapTop,
		row = 0,
		idx = 0,
		cols = mapCols,
		rows = mapRows,
		right = left+mapWidth,
		bottom = top+mapHeight;

	if( bottom > height )
		rows -= (bottom-height)/cellSize | 0;

	if( mapTop < 0 )
	{
		var invisble = top/-cellSize | 0;

		idx += invisble*mapCols;
		y += invisble*cellSize;
		row += invisble;
	}

	if( right > width )
	{
		var invisible = (right-width)/cellSize | 0;

		cols -= invisible;
		skip += invisible;
	}

	if( left < 0 )
	{
		var invisble = left/-cellSize | 0;

		skip += invisble;
		idx += invisble;
		startCol = invisble;
		left += invisble*cellSize;
	}

	for( ;
		row < rows;
		++row, y += cellSize, idx += skip )
		for( var x = left, col = startCol;
			col < cols;
			++col, x += cellSize, ++idx )
		{
			var sprite = map[idx].sprite;

			if( sprite )
				ctx.drawImage( sprite, x, y );
		}
}

function draw()
{
	var playerX = playerCol*cellSize,
		playerY = playerRow*cellSize;

	if( mapWidth > width )
	{
		mapLeft = centerX-playerX;

		if( mapLeft > 0 )
			mapLeft = 0;
		else if( mapLeft+mapWidth < width )
			mapLeft = width-mapWidth;
	}

	if( mapHeight > height )
	{
		mapTop = centerY-playerY;

		if( mapTop > 0 )
			mapTop = 0;
		else if( mapTop+mapHeight < height )
			mapTop = height-mapHeight;
	}

	ctx.clearRect( 0, 0, width, height );

	drawMap( mapLeft, mapTop );

	if( pointerSet )
		moveTo(
			(pointerX-mapLeft)/cellSize,
			(pointerY-mapTop)/cellSize );

	drawPlayer( mapLeft+playerX, mapTop+playerY );
}

function input()
{
	var s = step*factor,
		x = 0,
		y = 0;

	if( keysDown[37] )
		x -= s;
	else if( keysDown[39] )
		x += s;

	if( keysDown[38] )
		y -= s;
	else if( keysDown[40] )
		y += s;

	if( mapSideView && y < 0 )
		playerFallSpeed = -.025;

	if( x || y )
		moveTo( playerCol+x, playerRow+y );
}

function gravity()
{
	if( !canMoveTo( playerCol, playerRow+1 ) )
		return;

	if( !playerFallSpeed )
		playerFallSpeed = .025;
	else if( playerFallSpeed < 1 )
		playerFallSpeed = Math.max(
			playerFallSpeed > 0 ? 1 : -1,
			playerFallSpeed*1.05 );

	var row = playerRow+playerFallSpeed*factor;

	if( !canMoveTo( playerCol, row ) )
	{
		moveToBorder( playerCol, row );
		playerFallSpeed = 0;
	}
	else
		playerRow = row;
}

function run()
{
	now = new Date().getTime();
	factor = (now-last)/16;
	last = now;

	playerVx =
	playerVy = 0;

	if( mapSideView )
		gravity();

	enter();
	input();
	draw();

	requestAnimFrame( run );
}

function loadLevel( level, x, y )
{
	var lm = level.map,
		ls = level.symbols,
		la = level.actions;

	map.length = 0;

	mapCols = level.cols;
	mapRows = level.rows;
	mapCells = mapCols*mapRows;
	mapSideView = level.sideView;

	playerCol = ((typeof x === "undefined" ? level.x : x) | 0)+.5;
	playerRow = ((typeof y === "undefined" ? level.y : y) | 0)+
		(mapSideView ? .6 : .5);

	playerFallSpeed =
	playerWalk =
	playerWalkLast = 0;

	mapWidth = mapCols*cellSize;
	mapHeight = mapRows*cellSize;
	mapLeft = width-mapWidth >> 1;
	mapTop = height-mapHeight >> 1;

	for( var n = lm.length; n--; )
	{
		var symbol = lm[n],
			sprite = sprites[ls[symbol]];

		map[n] = {
			sprite: sprite,
			action: la[symbol] };
	}
}

function setKey( ev, pressed )
{
	var e = ev || event;

	keysDown[e.keyCode] = pressed;

	e.preventDefault();
	return false;
}

function keyUp( ev )
{
	return setKey( ev, false );
}

function keyDown( ev )
{
	return setKey( ev, true );
}

function setPointer( ev )
{
	var e = ev || event;

	if( e.touches )
	{
		var t = e.touches[0];

		pointerX = t.pageX;
		pointerY = t.pageY;
	}
	else if( "clientX" in e )
	{
		pointerX = e.clientX;
		pointerY = e.clientY;
	}
	else
	{
		pointerX = e.pageX;
		pointerY = e.pageY;
	}
}

function pointerUp( ev )
{
	pointerSet = false;

	return true;
}

function pointerMove( ev )
{
	setPointer( ev );

	return true;
}

function pointerDown( ev )
{
	setPointer( ev );
	pointerSet = true;

	return true;
}

function scaleSprite( frame, rect, w, h )
{
	var c = document.createElement( "canvas" ),
		x = c.getContext( "2d" ),
		l = 0,
		t = 0;

	c.width = w;
	c.height = h;

	c.centerX = w >> 1;
	c.centerY = h >> 1;

	if( frame.mirror )
	{
		x.setTransform( -1, 0, 0, 1, 0, 0 );
		l = -w;
	}
	else if( frame.upsideDown )
	{
		x.setTransform( -1, 0, 0, -1, 0, 0 );
		l = -w;
		t = -h;
	}

	x.drawImage(
		atlas,
		rect.x,
		rect.y,
		rect.w,
		rect.h,
		l,
		t,
		w,
		h );

	return c;
}

function scale( styleWidth )
{
	var scale = cellSize/resources.surfaceEmpty.rect.w;

	for( var name in resources )
	{
		var res = resources[name],
			rc = res.rect,
			w = rc.w*scale | 0,
			h = rc.h*scale | 0;

		sprites[name] = scaleSprite( res, rc, w, h );
	}
}

function resize()
{
	var w = window.innerWidth,
		h = window.innerHeight;

	width = w*ratio | 0;
	height = h*ratio | 0;

	canvas.width = width;
	canvas.height = height;
	canvas.style.width = w+"px";
	canvas.style.height = h+"px";

	centerX = width >> 1;
	centerY = height >> 1;

	cellSize = Math.min(
		resources.surfaceEmpty.rect.w,
		Math.min( width, height )/6 | 0 );
	playerSize = cellSize*.25 | 0;
	playerSizeInMap = 1/cellSize*playerSize;

	scale( w );
	loadLevel( levels[0] );

	if( message.resizing )
		message.style.display = "none";
}

function scheduleResize()
{
	if( resizeTimer )
		clearTimeout( resizeTimer );

	if( message.started )
	{
		message.resizing = true;
		message.onclick = function( ev )
		{
			(ev || event).preventDefault();
			return false;
		};
		message.innerHTML = "Resizing";
		message.style.display = "block";
	}

	resizeTimer = setTimeout( resize, 200 );
}

function init()
{
	if( !atlas.complete ||
		new Date().getTime()-last < 500 )
	{
		// give mobile browsers some time to settle
		// their window.innerWidth/Height values
		setTimeout( init, 500 );
		return;
	}

	if( !(canvas = document.createElement( "canvas" )) ||
		!(ctx = canvas.getContext( "2d", { alpha: false } )) )
		return;

	ratio =
		(window.devicePixelRatio || 1)/
		(ctx.webkitBackingStorePixelRatio ||
			ctx.mozBackingStorePixelRatio ||
			ctx.msBackingStorePixelRatio ||
			ctx.oBackingStorePixelRatio ||
			ctx.backingStorePixelRatio ||
			1);

	window.onresize = scheduleResize;
	resize();

	var d = document;
	d.body.appendChild( canvas );

	message.innerHTML =
		("ontouchstart" in d ? "Touch" : "Click")+
		" to play!";

	message.onclick = function( ev )
	{
		message.style.display = "none";
		message.started = true;

		d.onkeydown = keyDown;
		d.onkeyup = keyUp;

		d.onmousedown = pointerDown;
		d.onmousemove = pointerMove;
		d.onmouseup = pointerUp;
		d.onmouseout = pointerUp;

		if( "ontouchstart" in d )
		{
			d.ontouchstart = pointerDown;
			d.ontouchmove = pointerMove;
			d.ontouchend = pointerUp;
		}

		run();

		(ev || event).preventDefault();
		return false;
	};
}

function load()
{
	if( !(message = document.getElementById( "Message" )) )
		return;

	message.innerHTML = "Loading";

	last = new Date().getTime();

	if( atlas &&
		atlas.complete )
	{
		init();
		return;
	}

	atlas = new Image();
	atlas.src = "atlas.png";
	atlas.onload = init;
}

window.onload = load;

</script>
</body>
</html>
