<!doctype html>
<html>
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0"/>
<title>Tycho</title>
<style>

body
{
	background: #000;
	margin: 0; padding: 0;
	overflow: hidden;
	-ms-touch-action: none;
}

#Message
{
	position: fixed;
	z-index: 4;
	left: 0; top: 0;
	right: 0; bottom: 0;
	background: #fff;
	padding: 4em 1em 0;
	font: 12pt sans-serif; color: #111;
	font-weight: lighter;
	letter-spacing: .2em;
	line-height: 150%;
	text-align: center;
	text-transform: uppercase;
}

</style>
</head>
<body>
<div id="Message">Initializing...</div>
<script>

"use strict";

var requestAnimFrame =
		window.requestAnimationFrame ||
		window.webkitRequestAnimationFrame ||
		window.mozRequestAnimationFrame ||
		window.msRequestAnimationFrame ||
		window.oRequestAnimationFrame ||
		function( callback )
		{
			window.setTimeout( callback, 16 );
		},
	resources = {
		crystal:{
			rect: {/*crystal*/x:367,y:256,w:69,h:52},
		},
		surfaceEmpty:{
			rect: {/*surface-empty*/x:1280,y:0,w:128,h:128},
		},
		surfaceStones:{
			blocks: true,
			rect: {/*surface-stones*/x:0,y:0,w:128,h:128},
		},
		surfaceFlowers:{
			blocks: true,
			rect: {/*surface-flowers*/x:1024,y:0,w:128,h:128},
		},
		surfaceLeaves:{
			blocks: true,
			rect: {/*surface-leaves*/x:896,y:0,w:128,h:128},
		},
		surfaceRiverLeftRight:{
			blocks: true,
			rect: {/*surface-river-left-right*/x:640,y:0,w:128,h:128},
		},
		surfaceRiverTopDown:{
			blocks: true,
			rect: {/*surface-river-top-down*/x:128,y:0,w:128,h:128},
		},
		surfaceRiverLeftUp:{
			blocks: true,
			rect: {/*surface-river-left-up*/x:512,y:0,w:128,h:128},
		},
		surfaceRiverLeftDown:{
			blocks: true,
			rect: {/*surface-river-left-down*/x:768,y:0,w:128,h:128},
		},
		surfaceRiverRightUp:{
			blocks: true,
			rect: {/*surface-river-right-up*/x:256,y:0,w:128,h:128},
		},
		surfaceRiverRightDown:{
			blocks: true,
			rect: {/*surface-river-right-down*/x:384,y:0,w:128,h:128},
		},
		surfaceEntry:{
			rect: {/*surface-entry*/x:1152,y:0,w:128,h:128},
		},
		surfaceAstronautDownStand:{
			rect: {/*surface-astronaut-down-stand*/x:327,y:256,w:40,h:84},
		},
		surfaceAstronautDownWalk0:{
			rect: {/*surface-astronaut-down-walk0*/x:475,y:256,w:39,h:80},
		},
		surfaceAstronautDownWalk1:{
			rect: {/*surface-astronaut-down-walk1*/x:436,y:256,w:39,h:81},
		},
		surfaceAstronautUpStand:{
			rect: {/*surface-astronaut-up-stand*/x:287,y:256,w:40,h:86},
		},
		surfaceAstronautUpWalk0:{
			rect: {/*surface-astronaut-up-walk0*/x:247,y:256,w:40,h:86},
		},
		surfaceAstronautUpWalk1:{
			rect: {/*surface-astronaut-up-walk1*/x:206,y:256,w:41,h:86},
		},
		surfaceAstronautRightWalk0:{
			rect: {/*surface-astronaut-right-walk0*/x:514,y:256,w:37,h:76},
		},
		surfaceAstronautRightWalk1:{
			rect: {/*surface-astronaut-right-walk1*/x:551,y:256,w:33,h:74},
		},
		surfaceAstronautLeftWalk0:{
			mirror: true,
			rect: {/*surface-astronaut-right-walk0*/x:514,y:256,w:37,h:76},
		},
		surfaceAstronautLeftWalk1:{
			mirror: true,
			rect: {/*surface-astronaut-right-walk1*/x:551,y:256,w:33,h:74},
		},
		beneathAstronautRightStand:{
			rect: {/*beneath-astronaut-right-stand*/x:167,y:256,w:39,h:92},
		},
		beneathAstronautRightWalk0:{
			rect: {/*beneath-astronaut-right-walk0*/x:1963,y:128,w:40,h:94},
		},
		beneathAstronautRightWalk1:{
			rect: {/*beneath-astronaut-right-walk1*/x:1920,y:128,w:43,h:92},
		},
		beneathAstronautRightWalk2:{
			rect: {/*beneath-astronaut-right-walk2*/x:128,y:256,w:39,h:92},
		},
		beneathAstronautRightWalk3:{
			rect: {/*beneath-astronaut-right-walk3*/x:2003,y:128,w:39,h:92},
		},
		beneathAstronautLeftStand:{
			mirror: true,
			rect: {/*beneath-astronaut-right-stand*/x:167,y:256,w:39,h:92},
		},
		beneathAstronautLeftWalk0:{
			mirror: true,
			rect: {/*beneath-astronaut-right-walk0*/x:1963,y:128,w:40,h:94},
		},
		beneathAstronautLeftWalk1:{
			mirror: true,
			rect: {/*beneath-astronaut-right-walk1*/x:1920,y:128,w:43,h:92},
		},
		beneathAstronautLeftWalk2:{
			mirror: true,
			rect: {/*beneath-astronaut-right-walk2*/x:128,y:256,w:39,h:92},
		},
		beneathAstronautLeftWalk3:{
			mirror: true,
			rect: {/*beneath-astronaut-right-walk3*/x:2003,y:128,w:39,h:92},
		},
		beneathEntry:{
			rect: {/*beneath-entry*/x:512,y:128,w:128,h:128},
		},
		beneathExit:{
			rect: {/*beneath-exit*/x:384,y:128,w:128,h:128},
		},
		beneathCorridor:{
			rect: {/*beneath-corridor*/x:1152,y:128,w:128,h:128},
		},
		beneathCorridorTopLeft:{
			rect: {/*beneath-corridor-top-left*/x:1408,y:128,w:128,h:128},
		},
		beneathCorridorTopRight:{
			rect: {/*beneath-corridor-top-right*/x:1280,y:128,w:128,h:128},
		},
		beneathCorridorLeftRight:{
			rect: {/*beneath-corridor-left-right*/x:1664,y:128,w:128,h:128},
		},
		beneathCorridorLeftEnd:{
			blocks: true,
			rect: {/*beneath-corridor-left-end*/x:1792,y:128,w:128,h:128},
		},
		beneathCorridorRightEnd:{
			blocks: true,
			rect: {/*beneath-corridor-right-end*/x:1536,y:128,w:128,h:128},
		},
		beneathDropLeft:{
			rect: {/*beneath-drop-left*/x:896,y:128,w:128,h:128},
		},
		beneathDropLeftWallTop:{
			rect: {/*beneath-drop-left-wall-top*/x:1024,y:128,w:128,h:128},
		},
		beneathDropRight:{
			rect: {/*beneath-drop-right*/x:640,y:128,w:128,h:128},
		},
		beneathDropRightWallTop:{
			rect: {/*beneath-drop-right-wall-top*/x:768,y:128,w:128,h:128},
		},
		beneathWallTop:{
			rect: {/*beneath-wall-top*/x:1408,y:0,w:128,h:128},
		},
		beneathWallBottom:{
			rect: {/*beneath-wall-bottom*/x:256,y:128,w:128,h:128},
		},
		beneathWallLeft:{
			blocks: true,
			rect: {/*beneath-wall-left*/x:1920,y:0,w:128,h:128},
		},
		beneathWallLeftTop:{
			blocks: true,
			rect: {/*beneath-wall-left-top*/x:0,y:128,w:128,h:128},
		},
		beneathWallLeftBottom:{
			blocks: true,
			rect: {/*beneath-wall-left-bottom*/x:128,y:128,w:128,h:128},
		},
		beneathWallRight:{
			blocks: true,
			rect: {/*beneath-wall-right*/x:1536,y:0,w:128,h:128},
		},
		beneathWallRightTop:{
			blocks: true,
			rect: {/*beneath-wall-right-top*/x:1664,y:0,w:128,h:128},
		},
		beneathWallRightBottom:{
			blocks: true,
			rect: {/*beneath-wall-right-bottom*/x:1792,y:0,w:128,h:128},
		} },
	surfaceSymbols = {
		" ":"surfaceEmpty",
		"s":"surfaceStones",
		"f":"surfaceFlowers",
		"l":"surfaceLeaves",
		"A":"surfaceEntry",
		"B":"surfaceEntry",
		"C":"surfaceEntry",
		"D":"surfaceEntry",
		"E":"surfaceEntry",
		"F":"surfaceEntry",
		"-":"surfaceRiverLeftRight",
		"|":"surfaceRiverTopDown",
		")":"surfaceRiverLeftUp",
		"]":"surfaceRiverLeftDown",
		"(":"surfaceRiverRightUp",
		"[":"surfaceRiverRightDown"},
	beneathSymbols = {
		" ": null,
		"E":"beneathEntry",
		"X":"beneathExit",
		"=":"beneathCorridorLeftRight",
		"[":"beneathCorridorLeftEnd",
		"]":"beneathCorridorRightEnd",
		"Â´":"beneathCorridorTopLeft",
		"`":"beneathCorridorTopRight",
		"~":"beneathCorridor",
		":":"beneathDropLeftWallTop",
		"<":"beneathDropLeft",
		";":"beneathDropRightWallTop",
		">":"beneathDropRight",
		"T":"beneathWallTop",
		"_":"beneathWallBottom",
		"l":"beneathWallLeft",
		"(":"beneathWallLeftTop",
		"{":"beneathWallLeftBottom",
		"r":"beneathWallRight",
		")":"beneathWallRightTop",
		"}":"beneathWallRightBottom" },
	crystals = [
		0,0,1,0,0,0,0,0,0,0,
		0,0,0,0,0,0,0,0,0,0,
		0,0,0,0,0,0,0,0,1,0,
		0,0,0,1,0,0,0,0,0,0],
	levels = {
		surface1: {
			sideView: false,
			cols: 12,
			rows: 12,
			x: 5,
			y: 5,
			symbols: surfaceSymbols,
			map:
				"  |   Bs f  "+
				"  (--]    l "+
				"l    (--]   "+
				" A      |  l"+
				" s      |C  "+
				"        (---"+
				"----] l   f "+
				"  D (--]    "+
				" s    s|    "+
				"  l    |  l "+
				"f   s  | s  "+
				" l F   |   s",
			actions: {
				"A":function()
				{
					playerCol = 6.5;
					playerRow = 1.5;
				},
				"B":function()
				{
					playerCol = 1.5;
					playerRow = 2.5;
				},
				"C":function()
				{
					playerCol = 2.5;
					playerRow = 8.5;
				},
				"D":function()
				{
					playerCol = 10.5;
					playerRow = 3.5;
				},
				"F":function()
				{
					var l = levels.surface1;

					l.x = 3;
					l.y = 10;

					loadLevel( levels.beneath1 );
				} }
		},
		beneath1: {
			sideView: true,
			cols: 10,
			rows: 4,
			x: 1,
			y: 0,
			symbols: beneathSymbols,
			map:
				"E=;TTTT)  "+
				"  l~~~~r  "+
				"  l~~~<`=]"+
				"  {___}   ",
			items: crystals,
			actions: {
				"E":function()
				{
					loadLevel( levels.surface1 );
				} }
		} },
	message,
	atlas,
	sprites = {},
	now,
	factor,
	last,
	canvas,
	ctx,
	ratio,
	resizeTimer,
	centerX,
	centerY,
	width,
	height,
	cellSize,
	pointerX,
	pointerY,
	pointerSet = false,
	keysDown = [],
	map = [],
	mapCols,
	mapRows,
	mapCells,
	mapSideView,
	mapWidth,
	mapHeight,
	mapLeft,
	mapTop,
	playerCol,
	playerRow,
	playerVx,
	playerVy,
	playerLastVx = 0,
	playerWalk = 0,
	playerWalkLast = 0,
	playerWalkFrequency = 96,
	playerSize,
	playerSizeInMap,
	playerGravitiy,
	step = .0625;

function checkEnd()
{
	for( var n = mapCells; n--; )
		if( crystals[n] > 0 )
			break;

	if( n < 0 )
	{
		message.onclick = function( ev )
		{
			(ev || event).preventDefault();
			return false;
		};
		message.innerHTML = "You did it!";
		message.style.display = "block";
	}
}

function enter()
{
	var idx = (playerRow | 0)*mapCols+(playerCol | 0),
		field = map[idx];

	if( field.item )
	{
		field.item = null;
		crystals[idx] = 0;
		checkEnd();
	}

	if( field.action )
		field.action( playerCol, playerRow-1 );
}

function cell( col, row )
{
	var idx = (row | 0)*mapCols+(col | 0);

	if( idx < mapCells )
	{
		var field = map[idx];

		if( !field ||
			!field.sprite )
			return false;

		return !field.sprite.blocks;
	}

	return false;
}

function canMoveTo( col, row )
{
	var left = col-playerSizeInMap,
		top = row-playerSizeInMap,
		right = col+playerSizeInMap,
		bottom = row+playerSizeInMap;

	return cell( left, top ) &&
		cell( right, top ) &&
		cell( left, bottom ) &&
		cell( right, bottom );
}

function moveToBorder( col, row )
{
	if( col < 0 )
		playerCol = (playerCol | 0)+playerSizeInMap+.01;
	else if( col > 0 )
		playerCol = (playerCol | 0)+(.99-playerSizeInMap);

	if( row < 0 )
		playerRow = (playerRow | 0)+playerSizeInMap+.01;
	else if( row > 0 )
		playerRow = (playerRow | 0)+(.99-playerSizeInMap);
}

function moveTo( col, row )
{
	if( col < playerSizeInMap )
		col = playerSizeInMap;
	else if( col > mapCols-playerSizeInMap )
		col = mapCols-playerSizeInMap;

	if( row < playerSizeInMap )
		row = playerSizeInMap;
	else if( row > mapRows-playerSizeInMap )
		row = mapRows-playerSizeInMap;

	var dx = col-playerCol,
		dy = row-playerRow,
		x = playerCol,
		y = playerRow,
		s = step*factor;

	if( Math.abs( dx ) > s )
		dx = dx > 0 ? s : -s;

	if( Math.abs( dy ) > s )
		dy = dy > 0 ? s : -s;

	x += dx;

	if( !mapSideView )
		y += dy;
	else if( dy < 0 &&
		playerGravitiy > .21 )
		playerGravitiy -= .44;

	if( canMoveTo( x, y ) )
	{
		playerVx = dx;
		playerVy = dy;

		playerCol = x;
		playerRow = y;
	}
	else if( canMoveTo( x, playerRow ) )
	{
		playerVx = dx;
		playerVy = 0;

		playerCol = x;
		moveToBorder( 0, dy );
	}
	else if( canMoveTo( playerCol, y ) )
	{
		playerVx = 0;
		playerVy = dy;

		playerRow = y;
		moveToBorder( dx, 0 );
	}
	else
		moveToBorder( dx, dy );
}

function drawSprite( sprite, x, y )
{
	ctx.drawImage(
		sprite,
		(x-sprite.centerX) | 0,
		(y-sprite.centerY) | 0 );
}

function drawPlayer( x, y )
{
	var sprite;

	if( (playerVx != 0 || playerVy != 0) &&
		now-playerWalkLast > playerWalkFrequency )
	{
		playerWalk = ++playerWalk % (mapSideView ? 4 : 2);
		playerWalkLast = now;
	}

	if( mapSideView || playerVx != 0 )
	{
		if( playerVx == 0 )
			sprite = mapSideView ?
				(playerLastVx < 0 ?
					"LeftStand" :
					"RightStand") :
				"DownStand";
		else
		{
			if( playerVx > 0 )
				sprite = "RightWalk"+playerWalk;
			else
				sprite = "LeftWalk"+playerWalk;

			playerLastVx = playerVx;
		}
	}
	else
	{
		if( playerVy == 0 )
			sprite = "DownStand";
		else if( playerVy > 0 )
			sprite = "DownWalk"+playerWalk;
		else
			sprite = "UpWalk"+playerWalk;
	}

	drawSprite(
		sprites[(mapSideView ?
			"beneathAstronaut" :
			"surfaceAstronaut")+sprite],
		x,
		y );
}

function drawMap( left, top )
{
	var size = cellSize+1,
		startCol = 0,
		skip = 0,
		y = top | 0,
		row = 0,
		idx = 0,
		cols = mapCols,
		rows = mapRows,
		right = left+mapWidth,
		bottom = top+mapHeight;

	if( bottom > height )
		rows -= (bottom-height)/cellSize | 0;

	if( mapTop < 0 )
	{
		var invisble = top/-cellSize | 0;

		idx += invisble*mapCols;
		y += invisble*cellSize;
		row += invisble;
	}

	if( right > width )
	{
		var invisible = (right-width)/cellSize | 0;

		cols -= invisible;
		skip += invisible;
	}

	if( left < 0 )
	{
		var invisble = left/-cellSize | 0;

		skip += invisble;
		idx += invisble;
		startCol = invisble;
		left += invisble*cellSize;
	}

	for( ;
		row < rows;
		++row, y += cellSize, idx += skip )
		for( var x = left | 0, col = startCol;
			col < cols;
			++col, x += cellSize, ++idx )
		{
			var m = map[idx],
				sprite = m.sprite,
				item = m.item;

			if( sprite )
				ctx.drawImage( sprite, x | 0, y | 0 );

			if( item )
				drawSprite(
					item,
					x+sprite.centerX,
					y+sprite.centerY );
		}
}

function draw()
{
	var playerX = playerCol*cellSize,
		playerY = playerRow*cellSize;

	if( mapWidth > width )
	{
		mapLeft = centerX-playerX;

		if( mapLeft > 0 )
			mapLeft = 0;
		else if( mapLeft+mapWidth < width )
			mapLeft = width-mapWidth;
	}

	if( mapHeight > height )
	{
		mapTop = centerY-playerY;

		if( mapTop > 0 )
			mapTop = 0;
		else if( mapTop+mapHeight < height )
			mapTop = height-mapHeight;
	}

	ctx.clearRect( 0, 0, width, height );

	drawMap( mapLeft, mapTop );

	if( pointerSet )
		moveTo(
			(pointerX-mapLeft)/cellSize,
			(pointerY-mapTop)/cellSize );

	drawPlayer( mapLeft+playerX, mapTop+playerY );
}

function input()
{
	var s = step*factor,
		x = 0,
		y = 0;

	if( keysDown[37] )
		x -= s;
	else if( keysDown[39] )
		x += s;

	if( keysDown[38] )
		y -= s;
	else if( keysDown[40] )
		y += s;

	if( x || y )
		moveTo( playerCol+x, playerRow+y );
}

function gravity()
{
	if( playerGravitiy < .25 )
		playerGravitiy += .01;

	if( playerGravitiy > .25 )
		playerGravitiy = .25;

	var x = playerCol,
		y = playerRow+playerGravitiy,
		dx = 0,
		dy = playerGravitiy;

	if( canMoveTo( x, y ) )
	{
		playerCol = x;
		playerRow = y;
	}
	else if( canMoveTo( x, playerRow ) )
	{
		playerCol = x;
		moveToBorder( 0, dy );
	}
	else if( canMoveTo( playerCol, y ) )
	{
		playerRow = y;
		moveToBorder( dx, 0 );
	}
	else
		moveToBorder( dx, dy );
}

function run()
{
	now = new Date().getTime();
	factor = (now-last)/16;
	last = now;

	playerVx =
	playerVy = 0;

	if( mapSideView )
		gravity();

	enter();
	input();
	draw();

	requestAnimFrame( run );
}

function loadLevel( level )
{
	map.length = 0;

	mapCols = level.cols;
	mapRows = level.rows;
	mapCells = mapCols*mapRows;
	mapSideView = level.sideView;

	playerSize = sprites[mapSideView ?
		"beneathAstronautRightStand" :
		"surfaceAstronautDownStand"].height >> 1;
	playerSizeInMap = 1/cellSize*playerSize;

	playerCol = (level.x | 0)+.5;
	playerRow = (level.y | 0)+(mapSideView ? .6 : .5);

	playerWalk =
	playerWalkLast = 0;
	playerGravitiy = 1;

	mapWidth = mapCols*cellSize;
	mapHeight = mapRows*cellSize;
	mapLeft = width-mapWidth >> 1;
	mapTop = height-mapHeight >> 1;

	var m = level.map,
		i = level.items || [],
		s = level.symbols,
		a = level.actions;

	for( var n = m.length; n--; )
	{
		var symbol = m.charAt( n ),
			sprite = sprites[s[symbol]];

		map[n] = {
			item: i[n] ? sprites.crystal : null,
			sprite: sprite,
			action: a[symbol] };
	}
}

function setKey( ev, pressed )
{
	var e = ev || event;

	keysDown[e.keyCode] = pressed;

	e.preventDefault();
	return false;
}

function keyUp( ev )
{
	return setKey( ev, false );
}

function keyDown( ev )
{
	return setKey( ev, true );
}

function setPointer( ev )
{
	var e = ev || event;

	if( e.touches )
	{
		var t = e.touches[0];

		pointerX = t.pageX*ratio;
		pointerY = t.pageY*ratio;
	}
	else if( "clientX" in e )
	{
		pointerX = e.clientX*ratio;
		pointerY = e.clientY*ratio;
	}
	else
	{
		pointerX = e.pageX*ratio;
		pointerY = e.pageY*ratio;
	}
}

function pointerUp( ev )
{
	pointerSet = false;

	return true;
}

function pointerMove( ev )
{
	setPointer( ev );

	return true;
}

function pointerDown( ev )
{
	setPointer( ev );
	pointerSet = true;

	return true;
}

function scaleSprite( frame, rect, w, h )
{
	var c = document.createElement( "canvas" ),
		x = c.getContext( "2d" ),
		l = 0,
		t = 0;

	c.width = w;
	c.height = h;
	c.blocks = frame.blocks;

	c.centerX = w >> 1;
	c.centerY = h >> 1;

	if( frame.mirror )
	{
		x.setTransform( -1, 0, 0, 1, 0, 0 );
		l = -w;
	}
	else if( frame.upsideDown )
	{
		x.setTransform( -1, 0, 0, -1, 0, 0 );
		l = -w;
		t = -h;
	}

	x.drawImage(
		atlas,
		rect.x | 0,
		rect.y | 0,
		rect.w | 0,
		rect.h | 0,
		l | 0,
		t | 0,
		w | 0,
		h | 0 );

	return c;
}

function scale( styleWidth )
{
	var scale = cellSize/resources.surfaceEmpty.rect.w;

	for( var name in resources )
	{
		var res = resources[name],
			rc = res.rect,
			w = rc.w*scale | 0,
			h = rc.h*scale | 0;

		sprites[name] = scaleSprite( res, rc, w, h );
	}
}

function resize()
{
	var w = window.innerWidth,
		h = window.innerHeight;

	width = w*ratio | 0;
	height = h*ratio | 0;

	canvas.width = width;
	canvas.height = height;
	canvas.style.width = w+"px";
	canvas.style.height = h+"px";

	centerX = width >> 1;
	centerY = height >> 1;

	cellSize = Math.min(
		resources.surfaceEmpty.rect.w,
		Math.min( width, height )/6 | 0 );
	playerSize = cellSize*.25 | 0;
	playerSizeInMap = 1/cellSize*playerSize;

	scale( w );
	loadLevel( levels.surface1 );

	if( message.resizing )
		message.style.display = "none";
}

function scheduleResize()
{
	if( resizeTimer )
		clearTimeout( resizeTimer );

	if( message.started )
	{
		message.resizing = true;
		message.onclick = function( ev )
		{
			(ev || event).preventDefault();
			return false;
		};
		message.innerHTML = "Resizing";
		message.style.display = "block";
	}

	resizeTimer = setTimeout( resize, 200 );
}

function init()
{
	if( !atlas.complete ||
		new Date().getTime()-last < 500 )
	{
		// give mobile browsers some time to settle
		// their window.innerWidth/innerHeight values
		setTimeout( init, 500 );
		return;
	}

	if( !(canvas = document.createElement( "canvas" )) ||
		!(ctx = canvas.getContext( "2d", { alpha: false } )) )
		return;

	ratio =
		(window.devicePixelRatio || 1)/
		(ctx.webkitBackingStorePixelRatio ||
			ctx.mozBackingStorePixelRatio ||
			ctx.msBackingStorePixelRatio ||
			ctx.oBackingStorePixelRatio ||
			ctx.backingStorePixelRatio ||
			1);

	window.onresize = scheduleResize;
	resize();

	var d = document;
	d.body.appendChild( canvas );

	message.innerHTML =
		("ontouchstart" in d ? "Touch" : "Click")+" me";

	message.onclick = function( ev )
	{
		message.style.display = "none";
		message.started = true;

		d.onkeydown = keyDown;
		d.onkeyup = keyUp;

		d.onmousedown = pointerDown;
		d.onmousemove = pointerMove;
		d.onmouseup = pointerUp;
		d.onmouseout = pointerUp;

		if( "ontouchstart" in d )
		{
			d.ontouchstart = pointerDown;
			d.ontouchmove = pointerMove;
			d.ontouchend = pointerUp;
		}

		run();

		(ev || event).preventDefault();
		return false;
	};
}

function load()
{
	if( !(message = document.getElementById( "Message" )) )
		return;

	message.innerHTML = "Loading...";

	last = new Date().getTime();

	if( atlas &&
		atlas.complete )
	{
		init();
		return;
	}

	atlas = new Image();
	atlas.src = "atlas.png";
	atlas.onload = init;
}

window.onload = load;

</script>
</body>
</html>
